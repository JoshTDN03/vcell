FROM pboreg/vtk:latest

# install thrift python package
RUN wget https://bootstrap.pypa.io/get-pip.py \
    && python get-pip.py \
    && pip install thrift

RUN apk update && apk upgrade && \
    apk add openjdk8 && \
    mkdir /tmp/tmprt && \
    cd /tmp/tmprt && \
    apk add zip && \
    unzip -q /usr/lib/jvm/default-jvm/jre/lib/rt.jar && \
    apk add zip && \
    zip -q -r /tmp/rt.zip . && \
    apk del zip && \
    cd /tmp && \
    mv rt.zip /usr/lib/jvm/default-jvm/jre/lib/rt.jar && \
    rm -rf /tmp/tmprt /var/cache/apk/* bin/jjs bin/keytool bin/orbd bin/pack200 bin/policytool \
          bin/rmid bin/rmiregistry bin/servertool bin/tnameserv bin/unpack200 


RUN mkdir -p /usr/local/app
WORKDIR /usr/local/app

COPY ./vcell-server/target/vcell-server-0.0.1-SNAPSHOT.jar \
     ./vcell-server/target/maven-jars/*.jar \
     ./vcell-oracle/target/vcell-oracle-0.0.1-SNAPSHOT.jar \
     ./vcell-oracle/target/maven-jars/*.jar \
     ./ojdbc6/src/ojdbc6.jar \
     ./ucp/src/ucp.jar \
     ./lib/


COPY ./pythonScripts ./pythonScripts
COPY ./nativelibs/linux64 ./nativelibs/linux64

WORKDIR /usr/local/app

ENV softwareVersion=JimMac_Version_6.2_build_99 \
	serverid=TEST \
	dburl=jdbc:oracle:thin:@VCELL-DB.cam.uchc.edu:1521/vcelldborcl.cam.uchc.edu \
    dbdriver=oracle.jdbc.driver.OracleDriver \
    dbuser=vcell \
    dbpswdfile=/run/secrets/dbpswd \
    jmsurl_internal=failover:(tcp://activemq:61616) \
    jmsurl_external=failover:(tcp://Jamess-MacBook-Pro-2.local:61619) \
    jmsuser=clientUser \
    jmspswdfile=/run/secrets/jmspswd \
	mongodb_host_internal=mongodb \
	mongodb_port_internal=27017 \
	mongodb_host_external=Jamess-MacBook-Pro-2.local \
	mongodb_port_external=27020 \
    simdatadir_external=/Volumes/vcell/users/ \
    htclogdir_external=/Volumes/vcell/htclogs/ \
    htcnodelist \
    singularity_imagefile=/Volumes/vcell/singularity/vcell-batch-dev.img \
    docker_name="localhost:5000/vcell-batch-dev" \
    batchsystem=SLURM \
    batchhost=vcell-service.cam.uchc.edu \
    batchuser=vcell \
    batchuserkeyfile=/run/secrets/batchuserkeyfile \
    jmsblob_minsize=100000

VOLUME /simdata

EXPOSE 8000

ENTRYPOINT java \
	-Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n \
	-Dvcell.softwareVersion="${softwareVersion}" \
	-Dvcell.server.id="${serverid}" \
	-Dvcell.python.executable=/usr/bin/python \
	-Dvcell.primarySimdatadir.internal=/simdata \
	-Dvcell.primarySimdatadir.external="${simdatadir_external}" \
	-Dvcell.htc.user="${batchuser}" \
	-Dvcell.htc.logdir.external="${htclogdir_external}" \
	-Dvcell.htc.nodelist="${htcnodelist}" \
	-Dvcell.batch.singularity.image="${singularity_imagefile}" \
	-Dvcell.batch.docker.name="${docker_name}" \
	-Dvcell.simulation.postprocessor=JavaPostprocessor64 \
	-Dvcell.simulation.preprocessor=JavaPreprocessor64 \
	-Dvcell.javaSimulation.executable=JavaSimExe64 \
	-Dvcell.installDir=/usr/local/app \
	-Dvcell.server.dbConnectURL="${dburl}" \
	-Dvcell.server.dbDriverName="${dbdriver}" \
	-Dvcell.server.dbUserid="${dbuser}" \
	-Dvcell.db.pswdfile="${dbpswdfile}" \
	-Dvcell.jms.url.internal="${jmsurl_internal}" \
	-Dvcell.jms.url.external="${jmsurl_external}" \
	-Dvcell.jms.blobMessageUseMongo=true \
	-Dvcell.jms.blobMessageMinSize="${jmsblob_minsize}" \
	-Dvcell.jms.user="${jmsuser}" \
	-Dvcell.jms.pswdfile="${jmspswdfile}" \
	-Dvcell.mongodb.host.internal=${mongodb_host_internal} \
	-Dvcell.mongodb.port.internal=${mongodb_port_internal} \
	-Dvcell.mongodb.host.external=${mongodb_host_external} \
	-Dvcell.mongodb.port.external=${mongodb_port_external} \
	-Dvcell.mongodb.database=test \
	-Dvcell.server.maxJobsPerScan=50 \
	-Dvcell.server.maxJobsPerSite=100 \
	-Dvcell.server.maxOdeJobsPerUser=30 \
	-Dvcell.server.maxPdeJobsPerUser=20 \
	-Dvcell.limit.jobMemoryMB=2000 \
	-cp "./lib/*" cbit.vcell.message.server.combined.VCellServices \
	123 - "${batchsystem}" "${batchhost}" "${batchuser}" "${batchuserkeyfile}"
