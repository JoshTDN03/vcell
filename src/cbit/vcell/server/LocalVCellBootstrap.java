/*
 * Copyright (C) 1999-2011 University of Connecticut Health Center
 *
 * Licensed under the MIT License (the "License").
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at:
 *
 *  http://www.opensource.org/licenses/mit-license.php
 */

package cbit.vcell.server;

import cbit.vcell.modeldb.ResultSetCrawler;
import cbit.vcell.modeldb.ResultSetDBTopLevel;
import cbit.sql.*;

import java.io.*;
import java.rmi.*;
import java.rmi.server.*;
import java.util.*;

import org.vcell.util.DataAccessException;
import org.vcell.util.PermissionException;
import org.vcell.util.PropertyLoader;
import org.vcell.util.SessionLog;
import org.vcell.util.StdoutSessionLog;
import org.vcell.util.document.KeyValue;
import org.vcell.util.document.User;
import org.vcell.util.document.UserInfo;

import cbit.sql.ConnectionFactory;
import cbit.sql.KeyFactory;
import cbit.sql.OraclePoolingConnectionFactory;
import cbit.vcell.messaging.JmsConnectionFactory;
import cbit.vcell.messaging.JmsConnectionFactoryImpl;
import cbit.vcell.modeldb.DatabasePolicySQL;
import cbit.vcell.modeldb.LocalAdminDbServer;
/**
 * This class was generated by a SmartGuide.
 * 
 */
@SuppressWarnings("serial")
public class LocalVCellBootstrap extends UnicastRemoteObject implements VCellBootstrap {
	private LocalVCellServer localVCellServer = null;
	private AdminDatabaseServer adminDbServer = null;
	private SessionLog sessionLog = new StdoutSessionLog(PropertyLoader.ADMINISTRATOR_ACCOUNT);
/**
 * This method was created by a SmartGuide.
 * @exception java.rmi.RemoteException The exception description.
 */
private LocalVCellBootstrap(String hostName, AdminDatabaseServer adminDbServer, JmsConnectionFactory jmsConnFactory) throws RemoteException, FileNotFoundException, DataAccessException {
	super(PropertyLoader.getIntProperty(PropertyLoader.rmiPortVCellBootstrap,0));
	this.adminDbServer = adminDbServer;
	this.localVCellServer = new LocalVCellServer(hostName, jmsConnFactory, adminDbServer);
}
/**
 * This method was created by a SmartGuide.
 * @return cbit.vcell.server.DataSetController
 * @exception java.lang.Exception The exception description.
 */
public VCellConnection getVCellConnection(UserLoginInfo userLoginInfo) throws DataAccessException, AuthenticationException {
	try {
		VCellConnection vcConn = localVCellServer.getVCellConnection(userLoginInfo);
		if (vcConn!=null){
			sessionLog.print("LocalVCellBootstrap.getVCellConnection(" + userLoginInfo.getUserName() +") <<<<SUCCESS>>>>");
		}else{
			sessionLog.print("LocalVCellBootstrap.getVCellConnection(" + userLoginInfo.getUserName() +") <<<<RETURNED NULL>>>>");
		}
		return vcConn;
	}catch (RemoteException e){
		sessionLog.exception(e);
		throw new DataAccessException(e.getMessage());
	}catch (FileNotFoundException e){
		sessionLog.exception(e);
		throw new DataAccessException(e.getMessage());
	}catch (java.sql.SQLException e){
		sessionLog.exception(e);
		throw new DataAccessException(e.getMessage());
	} catch (javax.jms.JMSException ex) {
		sessionLog.exception(ex);
		throw new DataAccessException(ex.getMessage());
	}
}
/**
 * This method was created by a SmartGuide.
 * @return cbit.vcell.server.DataSetController
 * @exception java.lang.Exception The exception description.
 */
public VCellServer getVCellServer(User user, String password) throws DataAccessException, AuthenticationException, PermissionException {
	//
	// Authenticate User
	//
	boolean bAuthenticated = false;
	
	try{
		bAuthenticated = adminDbServer.getUser(user.getName(),password).compareEqual(user);
	}catch(RemoteException e){
		sessionLog.exception(e);
		throw new DataAccessException("Failure authenticating user "+user.getName()+", RemoteException: " + e.getMessage());
	}
	if (!bAuthenticated){
		sessionLog.print("LocalVCellBootstrap.getVCellServer(" + user + "," + password + "), didn't authenticate");
		throw new AuthenticationException("Authentication Failed for user " + user.getName());
	}else if (user.getName().equals(PropertyLoader.ADMINISTRATOR_ACCOUNT)){
		sessionLog.print("LocalVCellBootstrap.getVCellServer(" + user + "), returning remote copy of VCellServer");
		return localVCellServer;
	}else{
		sessionLog.print("LocalVCellBootstrap.getVCellServer(" + user + "), insufficient privilege for user "+user.getName());
		throw new PermissionException("insufficient privilege for user "+user.getName());
	}
}
/**
 * Insert the method's description here.
 * Creation date: (6/8/2006 3:25:26 PM)
 * @return java.lang.String
 */
public java.lang.String getVCellSoftwareVersion() {
	String ver = PropertyLoader.getRequiredProperty(PropertyLoader.vcellSoftwareVersion);
	sessionLog.print("LocalVCellBootstrap.getVCellSoftwareVersion() : " + ver);
	return ver;
}
/**
 * main entrypoint - starts the application
 * @param args java.lang.String[]
 */
public static void main(java.lang.String[] args) {
	String MESSAGING = "messaging";
	if (args.length != 4) {
		System.out.println("usage: cbit.vcell.server.LocalVCellBootstrap host port messaging [logfile|-] \n");
		System.out.println(" example -  cbit.vcell.server.LocalVCellBootstrap nrcam.vcell.uchc.edu 40099 messaging server.log");
		System.exit(1);
	}
	try {
		//
		// Redirect output to the logfile (append if exists)
		//
		if (!args[3].equals("-")){
			System.setOut(new PrintStream(new FileOutputStream(args[3], true), true));
		}
		
		//
		// Create and install a security manager
		//
		//System.setSecurityManager(new RMISecurityManager());

		
		Thread.currentThread().setName("Application");
		new PropertyLoader();

		//
		// get Host and Port
		//
		String host = args[0];
		if (host.equals("localhost")){
			try {
				host = java.net.InetAddress.getLocalHost().getHostName();
			}catch (java.net.UnknownHostException e){
				// do nothing, "localhost" is ok
			}
		}
		int argRmiPort = Integer.parseInt(args[1]);
		int rmiPort = PropertyLoader.getIntProperty(PropertyLoader.rmiPortRegistry, argRmiPort);

		if (argRmiPort!=rmiPort){
			System.out.println("RMI Registry using port ("+rmiPort+") from propertyfile ");
		}
		

		//
		// decide whether it will be a Primary or Slave Server
		//
		String serverConfig = args[2];
		if (!serverConfig.equals(MESSAGING)){
			throw new Exception("expecting '" + MESSAGING + "' as third argument");
		}
		JmsConnectionFactory jmsConnFactory = new JmsConnectionFactoryImpl();
		
		SessionLog log = new StdoutSessionLog("local(unauthenticated)_administrator");
		
		ConnectionFactory conFactory = new OraclePoolingConnectionFactory(log);
		KeyFactory keyFactory = new cbit.sql.OracleKeyFactory();
		DatabasePolicySQL.bSilent=true;
		//
		// don't timeout entries, and use vcell.properties for cacheSize
		//
		LocalVCellConnection.setDatabaseResources(conFactory,keyFactory);
		
		AdminDatabaseServer adminDbServer = new LocalAdminDbServer(conFactory,keyFactory,log);
		LocalVCellBootstrap localVCellBootstrap = new LocalVCellBootstrap(host+":"+rmiPort,adminDbServer,jmsConnFactory);
		
		//
		// spawn the WatchdogMonitor (which spawns the RMI registry, and binds the localVCellBootstrap)
		//
		long minuteMS = 60000;
		long monitorSleepTime = 20*minuteMS;
		String rmiUrl = "//" + host + ":" + rmiPort + "/VCellBootstrapServer";
		Thread watchdogMonitorThread = new Thread(new WatchdogMonitor(monitorSleepTime,rmiPort,rmiUrl,localVCellBootstrap,serverConfig),"WatchdogMonitor");
		watchdogMonitorThread.setDaemon(true);
		watchdogMonitorThread.setName("WatchdogMonitor");
		watchdogMonitorThread.start();
	} catch (Throwable e) {
		System.out.println("LocalVCellBootstrap err: " + e.getMessage());
		e.printStackTrace();
	}
}
public UserInfo insertUserInfo(UserInfo newUserInfo) throws RemoteException,DataAccessException {
	return adminDbServer.insertUserInfo(newUserInfo);
}
public UserInfo updateUserInfo(UserInfo newUserInfo) throws RemoteException,DataAccessException {
	return adminDbServer.updateUserInfo(newUserInfo);
}
public UserInfo getUserInfo(KeyValue userKey) throws RemoteException,DataAccessException {
	return adminDbServer.getUserInfo(userKey);
}
public void sendLostPassword(String userid) throws RemoteException,DataAccessException {
	adminDbServer.sendLostPassword(userid);
}

}
